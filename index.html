<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Downtime Tracker — Single File</title>
<meta name="theme-color" content="#0f172a">
<meta name="description" content="Tablet-friendly Downtime Tracker with offline capture and n8n sync (single-file).">
<link rel="icon" href="data:,">
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e5ecff; --muted:#9fb0d0;
  --accent:#6ee7b7; --primary:#60a5fa; --danger:#f87171; --wire:#1f2a44;
  --card:#111a2f; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --focus:#7dd3fc;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg,#081026,#0b1426 40%,#0b1220); color:var(--ink)}
.app-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;
  border-bottom:1px solid var(--wire);background:rgba(15,23,42,.85);backdrop-filter: blur(8px);position:sticky;top:0;z-index:10}
.brand{display:flex;align-items:center;gap:10px}.brand .logo{font-size:20px;opacity:.9}
.brand h1{margin:0;font-size:16px;font-weight:600;letter-spacing:.2px}
.status-cluster{display:flex;align-items:center;gap:14px}
.shift{display:flex;align-items:center;gap:6px;color:var(--muted)}
.clock{font-variant-numeric:tabular-nums;color:var(--ink)}
.sync-indicator{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
.sync-indicator .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:var(--warn);box-shadow:0 0 0 2px #0002}
.icon-btn{background:transparent;border:1px solid var(--wire);color:var(--ink);padding:6px 10px;border-radius:8px;cursor:pointer}
.icon-btn:hover{border-color:var(--focus)}
.layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
@media (max-width:1000px){.layout{grid-template-columns:1fr;padding:12px}}
.panel{background:var(--panel);border:1px solid var(--wire);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
form label{display:flex;flex-direction:column;gap:6px;font-size:14px;color:var(--muted)}
input,select,textarea{background:#0b152a;border:1px solid var(--wire);color:var(--ink);padding:10px 12px;border-radius:10px;font-size:14px;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px #0ea5e920}
textarea{min-height:66px;resize:vertical}
.grid.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:640px){.grid.two{grid-template-columns:1fr}}
.actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.btn{background:#0b152a;border:1px solid var(--wire);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .02s ease}
.btn:hover{border-color:var(--focus)} .btn:active{transform:translateY(1px)}
.btn.primary{background:#13284d;border-color:#2b4d8a}
.btn.accent{background:#0e2f2a;border-color:#235e53;color:#c7fff0}
.btn.danger{background:#341419;border-color:#8a2b3a;color:#ffd7dc}
.hint{color:var(--muted);font-size:12px;margin-top:10px}
.meta{color:var(--muted);font-size:12px;margin-top:6px}
.chart-card{background:var(--card);border:1px solid var(--wire);border-radius:12px;padding:12px;margin-bottom:12px}
.chart-card h3{margin:0 0 8px;font-size:14px;color:#cfe3ff}
.toasts{position:fixed;bottom:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0a1a33;border:1px solid var(--wire);color:var(--ink);padding:10px 12px;border-radius:12px;min-width:220px;max-width:360px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
kbd{background:#0b182e;border:1px solid var(--wire);border-radius:6px;padding:0 6px;font-size:12px}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input.inline{max-width:440px}
</style>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="brand">
      <span class="logo">⧉</span>
      <h1>Downtime Tracker</h1>
    </div>
    <div class="status-cluster">
      <div class="shift" aria-live="polite">
        <span id="shiftLabel">Shift</span>
        <span id="clock" class="clock"></span>
      </div>
      <div class="sync-indicator" id="syncIndicator" aria-live="polite" title="Sync status">
        <span class="dot" id="syncDot" aria-hidden="true"></span>
        <span id="syncText">Idle</span>
      </div>
      <button id="adminBtn" class="icon-btn" aria-label="Open Settings" title="Settings">⚙️</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel form-panel" aria-labelledby="formTitle">
      <h2 id="formTitle">Log Downtime</h2>

      <div class="row small">
        <label>Webhook URL
          <input id="webhookUrl" class="inline" type="url" placeholder="https://your-n8n/webhook/downtime">
        </label>
        <button id="saveWebhook" class="btn">Save URL</button>
        <span id="webhookSaved" class="small"></span>
      </div>

      <form id="stopForm" novalidate>
        <div class="grid two">
          <label>Plant
            <select id="plant" required aria-required="true"></select>
          </label>
          <label>Line
            <select id="line" required aria-required="true" disabled></select>
          </label>
          <label>Machine
            <select id="machine" required aria-required="true" disabled></select>
          </label>
          <label>Category
            <select id="category" required aria-required="true"></select>
          </label>
          <label>Reason
            <select id="reason" required aria-required="true" disabled></select>
          </label>
          <label>Severity
            <select id="severity" required aria-required="true">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
            </select>
          </label>
          <label>Start
            <input id="start" type="datetime-local" required aria-required="true">
          </label>
          <label>End
            <input id="end" type="datetime-local">
          </label>
        </div>

        <label>Note
          <textarea id="note" placeholder="Optional notes (max 500 chars)" maxlength="500"></textarea>
        </label>
        <div class="grid two">
          <label>Operator ID
            <input id="operatorId" type="text" placeholder="Scan or enter ID">
          </label>
          <label>Attachment (optional, ≤1MB, images/pdf only)
            <input id="attachment" type="file" accept=".png,.jpg,.jpeg,.pdf" />
          </label>
        </div>

        <div class="actions">
          <button type="button" id="startBtn" class="btn">Start Stop</button>
          <button type="button" id="endBtn" class="btn">End Stop</button>
          <button type="button" id="saveBtn" class="btn primary">Save</button>
          <button type="button" id="submitBtn" class="btn accent">Submit to n8n</button>
          <button type="button" id="discardBtn" class="btn danger">Discard</button>
        </div>
        <p class="hint">Shortcuts: <kbd>S</kbd> Save, <kbd>E</kbd> End Stop, <kbd>N</kbd> New</p>
      </form>
      <div id="lastSaved" class="meta"></div>
    </section>

    <section class="panel charts-panel" aria-labelledby="chartsTitle">
      <h2 id="chartsTitle">Live Insights</h2>
      <div class="chart-card">
        <h3>Pareto: Top 5 Reasons (this shift)</h3>
        <canvas id="paretoChart" width="400" height="220" aria-label="Pareto chart" role="img"></canvas>
      </div>
      <div class="chart-card">
        <h3>Downtime by Machine</h3>
        <canvas id="machineChart" width="400" height="220" aria-label="Downtime by machine bar chart" role="img"></canvas>
      </div>
      <div class="chart-card">
        <h3>Trend: Last 24h</h3>
        <canvas id="trendChart" width="400" height="220" aria-label="Downtime trend line chart" role="img"></canvas>
      </div>
    </section>
  </main>

  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

<script type="module">
/* ===== Utilities ===== */
const $ = (s)=> document.querySelector(s);
function toast(msg, timeout=2500){
  const host = $('#toasts'); const el = document.createElement('div');
  el.className='toast'; el.textContent=msg; host.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=> host.removeChild(el), 300); }, timeout);
}
function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
  const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
});}
function computeMinutes(startIso, endIso){
  if(!startIso) return 0;
  const s = new Date(startIso).getTime();
  const e = endIso ? new Date(endIso).getTime() : Date.now();
  return Math.max(0, Math.round((e-s)/60000));
}
function nowLocalInput(){
  const d = new Date(); const off = d.getTimezoneOffset();
  return new Date(d.getTime()-off*60000).toISOString().slice(0,16);
}
function setSyncStatus(status){
  const dot = $('#syncDot'); const text = $('#syncText'); text.textContent = status;
  if(status==='Idle'){ dot.style.background='var(--warn)'; }
  else if(status==='Online'){ dot.style.background='var(--ok)'; }
  else if(status==='Syncing…'){ dot.style.background='var(--primary)'; }
  else if(status==='Error'){ dot.style.background='var(--bad)'; }
}

/* ===== Clock & Shift ===== */
function updateClock(){
  const now = new Date(); $('#clock').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const h = now.getHours();
  let label = 'Shift A (06–14)'; if(h>=14 && h<22) label='Shift B (14–22)'; if(h>=22 || h<6) label='Shift C (22–06)';
  $('#shiftLabel').textContent = label;
}
setInterval(updateClock, 5000); updateClock();
setSyncStatus(navigator.onLine? 'Online':'Idle');
window.addEventListener('online', ()=> setSyncStatus('Online'));
window.addEventListener('offline', ()=> setSyncStatus('Idle'));

/* ===== IndexedDB (tiny wrapper) ===== */
const DB_NAME='dt-single'; const DB_VER=1; let _db;
async function dbOpen(){
  if(_db) return _db;
  _db = await new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains('stops')){
        const s = db.createObjectStore('stops',{keyPath:'localId'}); s.createIndex('createdAt','createdAt');
      }
      if(!db.objectStoreNames.contains('masters')) db.createObjectStore('masters',{keyPath:'id'});
      if(!db.objectStoreNames.contains('syncQueue')){
        const q = db.createObjectStore('syncQueue',{keyPath:'id'}); q.createIndex('nextAttempt','nextAttempt');
      }
    };
    req.onsuccess=()=> resolve(req.result); req.onerror=()=> reject(req.error);
  });
  return _db;
}
function tx(name,mode='readonly'){ return _db.transaction(name,mode).objectStore(name); }
async function mastersGet(){ const db=await dbOpen(); return new Promise((res,rej)=>{ const r=tx('masters').get('masters'); r.onsuccess=()=>res(r.result?.data); r.onerror=()=>rej(r.error); }); }
async function mastersSet(data){ const db=await dbOpen(); return new Promise((res,rej)=>{ const r=tx('masters','readwrite').put({id:'masters',data}); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }
async function stopPut(stop){ const db=await dbOpen(); const now=new Date().toISOString(); stop.updatedAt=now; if(!stop.createdAt) stop.createdAt=now;
  return new Promise((res,rej)=>{ const r=tx('stops','readwrite').put(stop); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); });
}
async function stopsList(){ const db=await dbOpen(); return new Promise((res,rej)=>{ const r=tx('stops').getAll(); r.onsuccess=()=>{ const arr=r.result||[]; arr.sort((a,b)=>(a.start||'').localeCompare(b.start)); res(arr);}; r.onerror=()=>rej(r.error); }); }
async function qAdd(item){ const db=await dbOpen(); return new Promise((res,rej)=>{ const r=tx('syncQueue','readwrite').put(item); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }
async function qDelete(id){ const db=await dbOpen(); return new Promise((res,rej)=>{ const r=tx('syncQueue','readwrite').delete(id); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }
async function qDue(nowIso){ const db=await dbOpen(); return new Promise((res)=>{ const s=tx('syncQueue').index('nextAttempt'); const range=IDBKeyRange.upperBound(nowIso); const items=[]; s.openCursor(range).onsuccess=(e)=>{ const c=e.target.result; if(c){items.push(c.value); c.continue();} else res(items); }; }); }
async function qAll(){ const db=await dbOpen(); return new Promise((res,rej)=>{ const r=tx('syncQueue').getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); }); }

/* ===== Masters defaults ===== */
const defaults = {
  plants:['Plant A','Plant B'],
  lines:[{plant:'Plant A',name:'Line 1'},{plant:'Plant A',name:'Line 2'},{plant:'Plant B',name:'Line X'}],
  machines:[{plant:'Plant A',line:'Line 1',name:'SMT-1'},{plant:'Plant A',line:'Line 1',name:'SMT-2'},{plant:'Plant A',line:'Line 2',name:'PACK-1'},{plant:'Plant B',line:'Line X',name:'IM-3'}],
  categories:[
    {name:'Mechanical', reasons:['Belt break','Bearing wear','Clamp jam']},
    {name:'Electrical', reasons:['Sensor fault','Motor overload','Wiring']},
    {name:'Material', reasons:['Shortage','Wrong spec','Damaged roll']},
    {name:'Setup', reasons:['Changeover','Calibration','Tooling']},
    {name:'Quality', reasons:['Rework','Scrap investigation','Inspection']},
    {name:'Other', reasons:['Cleaning','Meeting','Safety']}
  ]
};
let masters = null;

/* ===== Charts ===== */
let pareto,machineBar,trendLine;
function initCharts(){
  const pc=$('#paretoChart').getContext('2d');
  const mc=$('#machineChart').getContext('2d');
  const tc=$('#trendChart').getContext('2d');
  pareto = new Chart(pc,{type:'bar',data:{labels:[],datasets:[{label:'Minutes',data:[]}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  machineBar = new Chart(mc,{type:'bar',data:{labels:[],datasets:[{label:'Minutes',data:[]}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  trendLine = new Chart(tc,{type:'line',data:{labels:[],datasets:[{label:'Minutes',data:[],tension:.3}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
}
function refreshCharts(stops){
  if(!stops) return;
  const now=new Date(); let sh=6, eh=14; const h=now.getHours();
  if(h>=14 && h<22){sh=14; eh=22;} if(h>=22 || h<6){sh=22; eh=30;}
  const startShift=new Date(now); startShift.setHours(sh%24,0,0,0);
  const endShift=new Date(now); endShift.setHours(eh%24,0,0,0); if(eh===30) endShift.setDate(endShift.getDate()+1);

  const inShift=stops.filter(s=> new Date(s.start)>=startShift && new Date(s.start)<endShift);
  const reasonMin={}; const machineMin={};
  for(const s of inShift){ const m=computeMinutes(s.start,s.end); reasonMin[s.reason]=(reasonMin[s.reason]||0)+m; machineMin[s.machine]=(machineMin[s.machine]||0)+m; }
  const topReasons=Object.entries(reasonMin).sort((a,b)=>b[1]-a[1]).slice(0,5);
  pareto.data.labels=topReasons.map(x=>x[0]); pareto.data.datasets[0].data=topReasons.map(x=>x[1]); pareto.update();

  const machines=Object.entries(machineMin).sort((a,b)=>a[0].localeCompare(b[0]));
  machineBar.data.labels=machines.map(x=>x[0]); machineBar.data.datasets[0].data=machines.map(x=>x[1]); machineBar.update();

  const dayAgo=new Date(now.getTime()-24*3600*1000); const buckets=new Map();
  for(let i=0;i<24;i++){ const label=new Date(dayAgo.getTime()+i*3600*1000).toLocaleTimeString([], {hour:'2-digit'}); buckets.set(label,0); }
  for(const s of stops){ const st=new Date(s.start); if(st>=dayAgo){ const label=st.toLocaleTimeString([], {hour:'2-digit'}); buckets.set(label, buckets.get(label)+computeMinutes(s.start,s.end)); } }
  trendLine.data.labels=Array.from(buckets.keys()); trendLine.data.datasets[0].data=Array.from(buckets.values()); trendLine.update();
}

/* ===== Form population ===== */
function populatePlant(){
  const sel=$('#plant'); sel.innerHTML='';
  masters.plants.forEach(p=> sel.append(new Option(p,p)));
  sel.onchange=onPlantChange; onPlantChange();
}
function onPlantChange(){
  const plant=$('#plant').value;
  const lines=masters.lines.filter(l=> l.plant===plant).map(l=> l.name);
  const lineSel=$('#line'); lineSel.innerHTML=''; lines.forEach(n=> lineSel.append(new Option(n,n)));
  lineSel.disabled = lines.length===0; lineSel.onchange=onLineChange; onLineChange();
}
function onLineChange(){
  const plant=$('#plant').value; const line=$('#line').value;
  const machines=masters.machines.filter(m=> m.plant===plant && m.line===line).map(m=> m.name);
  const mSel=$('#machine'); mSel.innerHTML=''; machines.forEach(n=> mSel.append(new Option(n,n)));
  mSel.disabled = machines.length===0;
}
function populateCategory(){
  const sel=$('#category'); sel.innerHTML='';
  masters.categories.forEach(c=> sel.append(new Option(c.name,c.name)));
  sel.onchange=onCategoryChange; onCategoryChange();
}
function onCategoryChange(){
  const cat=$('#category').value; const catObj=masters.categories.find(c=> c.name===cat);
  const reasons=catObj? catObj.reasons:[]; const rSel=$('#reason'); rSel.innerHTML='';
  reasons.forEach(r=> rSel.append(new Option(r,r))); rSel.disabled=reasons.length===0;
}

/* ===== Attachments ===== */
function readAttachment(){
  const f = $('#attachment').files[0];
  return new Promise((resolve)=>{
    if(!f) return resolve(null);
    if(f.size>1024*1024){ toast('Attachment too large (max 1MB)'); return resolve(null); }
    const allowed=['image/png','image/jpeg','application/pdf'];
    if(!allowed.includes(f.type)){ toast('Attachment type not allowed'); return resolve(null); }
    const reader=new FileReader(); reader.onload=()=> resolve({name:f.name,type:f.type,size:f.size,dataUrl:reader.result}); reader.readAsDataURL(f);
  });
}

/* ===== Validation ===== */
function validate(){
  const req=['plant','line','machine','category','reason','severity','start']; let ok=true;
  for(const id of req){ const el=document.getElementById(id); if(!el.value){ el.style.borderColor='#ef4444'; ok=false; } else el.style.borderColor=''; }
  if(!ok) toast('Please fill all required fields'); return ok;
}

/* ===== Save / Submit ===== */
function toIsoLocal(d){ return d ? new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString() : null; }
function collectStop(att){
  const start = $('#start').value ? new Date($('#start').value) : new Date();
  const endV  = $('#end').value ? new Date($('#end').value) : null;
  return {
    localId: uuid(), serverId:null,
    plant: $('#plant').value, line: $('#line').value, machine: $('#machine').value,
    category: $('#category').value, reason: $('#reason').value, severity: $('#severity').value,
    start: toIsoLocal(start), end: toIsoLocal(endV), minutes:0,
    note: $('#note').value.trim(), operatorId: $('#operatorId').value.trim(),
    attachments: att ? [att] : [], status: 'saved', createdAt:null, updatedAt:null
  };
}
async function saveStop(){
  if(!validate()) return;
  const att = await readAttachment(); const stop=collectStop(att);
  await stopPut(stop);
  $('#lastSaved').textContent='Saved '+ new Date().toLocaleTimeString(); toast('Saved locally');
  $('#end').value='';
  refreshCharts(await stopsList());
}
async function submitStop(){
  if(!validate()) return;
  const att = await readAttachment(); const stop=collectStop(att);
  await stopPut(stop); await enqueueForSync(stop); refreshCharts(await stopsList());
}

/* ===== Sync queue ===== */
let inflight = 0;
function jitter(ms){ return Math.floor(ms + (Math.random()*0.3*ms)); }
function backoff(attempt){ return jitter(2000 * Math.pow(2, Math.min(6, attempt))); }
async function enqueueForSync(stop){
  const item = { id: uuid(), status:'queued', attempts:0, lastError:null, nextAttempt: new Date().toISOString(), stop };
  await qAdd(item); toast('Queued for sync'); processDue();
}
async function processDue(){
  if(!navigator.onLine) return;
  const now = new Date().toISOString(); const due = await qDue(now);
  if(!due.length) { setSyncStatus('Online'); return; }
  setSyncStatus('Syncing…');
  for(const item of due){
    inflight++;
    try{
      await sendOne(item);
      await qDelete(item.id);
      toast('Sync successful');
    }catch(err){
      item.attempts=(item.attempts||0)+1; item.status='retry'; item.lastError=String(err);
      item.nextAttempt=new Date(Date.now()+backoff(item.attempts)).toISOString();
      await qAdd(item);
      setSyncStatus('Error');
      toast('Sync error: '+ (err?.message || String(err)));
    }finally{
      inflight--;
    }
  }
  setSyncStatus(navigator.onLine? 'Online':'Idle');
}
async function sendOne(item){
  const webhook = (localStorage.getItem('N8N_WEBHOOK_URL')||'').trim();
  if(!webhook){ throw new Error('Webhook URL not set'); }
  const payload = {
    event:'downtime_log', source:'dac-web', ts_client:new Date().toISOString(),
    payload:{
      plant:item.stop.plant,line:item.stop.line,machine:item.stop.machine,category:item.stop.category,reason:item.stop.reason,
      severity:item.stop.severity,start:item.stop.start,end:item.stop.end||null,minutes:computeMinutes(item.stop.start,item.stop.end),
      note:item.stop.note||'',operatorId:item.stop.operatorId||'',attachments:item.stop.attachments||[],
      clientId:item.stop.clientId||item.stop.localId, localId:item.stop.localId, version:1
    }
  };
  const res = await fetch(webhook, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  if(res.status>=500) throw new Error('Server '+res.status);
  if(res.status>=400){
    if((item.attempts||0)<3) throw new Error('HTTP '+res.status); else throw new Error('Permanent '+res.status);
  }
  let data={}; try{ data=await res.json(); }catch{}
  const serverId = data.serverId || (data.data && data.data.serverId) || null;
  // Save back to stop
  const s = item.stop; s.serverId=serverId; s.status='synced'; await stopPut(s);
}
setInterval(()=> processDue(), 3000);
window.addEventListener('online', ()=> processDue());

/* ===== UI wiring ===== */
function wireButtons(){
  $('#startBtn').onclick=()=>{ $('#start').value=nowLocalInput(); toast('Start timestamp set'); };
  $('#endBtn').onclick=()=>{ $('#end').value=nowLocalInput(); toast('End timestamp set'); };
  $('#saveBtn').onclick=saveStop; $('#submitBtn').onclick=submitStop; $('#discardBtn').onclick=()=> resetForm();
  document.addEventListener('keydown',(e)=>{
    if(['INPUT','TEXTAREA','SELECT'].includes((e.target||{}).tagName)) return;
    if(e.key.toLowerCase()==='s'){ e.preventDefault(); saveStop(); }
    if(e.key.toLowerCase()==='e'){ e.preventDefault(); $('#endBtn').click(); }
    if(e.key.toLowerCase()==='n'){ e.preventDefault(); resetForm(); }
  });
  $('#saveWebhook').onclick=()=>{
    const v = $('#webhookUrl').value.trim();
    localStorage.setItem('N8N_WEBHOOK_URL', v);
    $('#webhookSaved').textContent = v ? 'Saved' : 'Cleared';
    toast('Webhook URL saved');
  };
}
function resetForm(){
  $('#stopForm').reset(); $('#start').value=nowLocalInput(); $('#end').value='';
  $('#lastSaved').textContent=''; for(const el of document.querySelectorAll('input,select,textarea')) el.style.borderColor='';
}

/* ===== Bootstrap ===== */
(async function bootstrap(){
  await dbOpen();
  masters = await mastersGet();
  if(!masters || !masters.plants) { await mastersSet(defaults); masters = defaults; }
  initCharts();
  populatePlant(); populateCategory();
  resetForm();
  wireButtons();
  // Webhook init
  const saved = localStorage.getItem('N8N_WEBHOOK_URL') || '';
  $('#webhookUrl').value = saved;
  refreshCharts(await stopsList());
})();
</script>
</body>
</html>
